<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Org Chart 2026</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f1f5f9;
      color: #0f172a;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ---- TOOLBAR ---- */
    #toolbar {
      background: #0f172a;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-shrink: 0;
    }

    #toolbar-logo {
      height: 32px;
      width: auto;
      object-fit: contain;
    }

    #toolbar h1 {
      font-size: 18px;
      font-weight: 700;
      color: #f8fafc;
      margin-right: auto;
    }

    #toolbar button {
      padding: 6px 14px;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 6px;
      background: transparent;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: #cbd5e1;
      transition: all 0.15s;
    }

    #toolbar button:hover {
      background: rgba(255,255,255,0.08);
      color: #f8fafc;
      border-color: rgba(255,255,255,0.25);
    }

    #btn-admin {
      background: #10b981 !important;
      color: #fff !important;
      border-color: #10b981 !important;
      font-weight: 600 !important;
    }

    #btn-admin:hover { background: #059669 !important; border-color: #059669 !important; }

    #search-box {
      padding: 7px 12px;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 6px;
      font-size: 13px;
      width: 220px;
      outline: none;
      background: #1e293b;
      color: #f1f5f9;
      font-family: inherit;
    }

    #search-box::placeholder { color: #64748b; }

    #search-box:focus { border-color: #10b981; box-shadow: 0 0 0 2px rgba(16,185,129,0.25); }

    /* ---- STATS BAR ---- */
    #stats {
      background: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      gap: 24px;
      flex-shrink: 0;
      flex-wrap: wrap;
    }

    .stat-item {
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .stat-value {
      font-size: 22px;
      font-weight: 700;
      color: #0f172a;
    }

    .stat-label {
      font-size: 11px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }

    .stat-divider {
      width: 1px;
      height: 28px;
      background: #e2e8f0;
    }

    .dept-stats {
      display: flex;
      gap: 12px;
      margin-left: auto;
    }

    .dept-stat {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      font-weight: 600;
      color: #64748b;
    }

    .dept-stat-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .dept-stat-count {
      color: #0f172a;
      font-weight: 700;
    }

    /* ---- MAIN CONTENT ---- */
    #main {
      flex: 1;
      display: flex;
      overflow: hidden;
      min-height: 0;
    }

    /* ---- VIEWPORT ---- */
    #viewport {
      flex: 1;
      margin: 16px;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      background:
        radial-gradient(circle, #cbd5e1 0.5px, transparent 0.5px);
      background-size: 24px 24px;
      background-color: #f1f5f9;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.04);
    }

    #canvas {
      width: 100%;
      height: 100%;
      overflow: hidden;
      cursor: grab;
      touch-action: none;
    }

    #canvas.grabbing { cursor: grabbing; }

    #chart-container {
      transform-origin: 0 0;
      will-change: transform;
      padding: 40px;
      display: inline-block;
    }

    /* ---- LEGEND ---- */
    #legend {
      position: absolute;
      bottom: 12px;
      left: 12px;
      z-index: 10;
      background: #0f172a;
      backdrop-filter: blur(8px);
      border-radius: 8px;
      padding: 8px 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      border: 1px solid rgba(255,255,255,0.08);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 10px;
      font-weight: 500;
      color: #94a3b8;
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    /* ---- ADMIN PANEL (full-screen overlay with table) ---- */
    #admin-panel {
      position: fixed;
      inset: 0;
      background: #fff;
      display: none;
      flex-direction: column;
      z-index: 200;
      overflow: hidden;
    }

    #admin-panel.open {
      display: flex;
    }

    #admin-header {
      padding: 20px 28px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-shrink: 0;
    }

    #admin-header h2 {
      font-size: 18px;
      font-weight: 700;
      color: #0f172a;
      flex: 1;
    }

    #admin-header button {
      padding: 6px 14px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: #334155;
      transition: all 0.15s;
    }

    #admin-header button:hover { background: #f8fafc; border-color: #cbd5e1; }

    .btn-primary {
      background: #10b981 !important;
      color: #fff !important;
      border-color: #059669 !important;
    }

    .btn-primary:hover { background: #059669 !important; }

    .btn-danger {
      background: #ef4444 !important;
      color: #fff !important;
      border-color: #dc2626 !important;
    }

    .btn-danger:hover { background: #dc2626 !important; }

    #admin-actions {
      padding: 12px 28px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    #admin-search {
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 13px;
      width: 300px;
      outline: none;
      font-family: inherit;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    #admin-search:focus { border-color: #10b981; box-shadow: 0 0 0 2px rgba(16,185,129,0.2); }

    #admin-list {
      flex: 1;
      overflow-y: auto;
      overflow-x: auto;
      padding: 0;
    }

    #admin-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    #admin-table thead {
      position: sticky;
      top: 0;
      background: #f8fafc;
      z-index: 1;
    }

    #admin-table th {
      padding: 10px 16px;
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #e2e8f0;
      white-space: nowrap;
    }

    #admin-table td {
      padding: 10px 16px;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: middle;
    }

    #admin-table tbody tr {
      cursor: pointer;
      transition: all 0.1s;
    }

    #admin-table tbody tr:hover {
      background: #f1f5f9;
    }

    .admin-dept-badge {
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
      display: inline-block;
    }

    .admin-edit-btn {
      padding: 4px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      font-family: inherit;
      color: #334155;
      transition: all 0.15s;
    }

    .admin-edit-btn:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }

    /* ---- EDIT FORM (modal overlay) ---- */
    #edit-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.5);
      backdrop-filter: blur(4px);
      z-index: 500;
      align-items: center;
      justify-content: center;
    }

    #edit-overlay.open { display: flex; }

    #edit-form {
      background: #fff;
      border-radius: 14px;
      padding: 28px 32px;
      width: 420px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 24px 64px rgba(0,0,0,0.2);
    }

    #edit-form h3 {
      font-size: 16px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 14px;
    }

    .form-group label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 13px;
      outline: none;
      font-family: inherit;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    .form-group input:focus,
    .form-group select:focus {
      border-color: #10b981;
      box-shadow: 0 0 0 2px rgba(16,185,129,0.2);
    }

    .form-buttons {
      display: flex;
      gap: 8px;
      margin-top: 20px;
      justify-content: flex-end;
    }

    .form-buttons button {
      padding: 8px 18px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
      color: #334155;
      transition: all 0.15s;
    }

    .form-buttons button:hover { background: #f8fafc; border-color: #cbd5e1; }

    /* ---- SYNC STATUS ---- */
    #sync-bar {
      padding: 10px 28px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
      font-size: 11px;
      color: #64748b;
      font-weight: 500;
    }

    #sync-bar .sync-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
    }

    #sync-bar .sync-dot.unsaved { background: #f59e0b; }
    #sync-bar .sync-dot.saving { background: #3b82f6; animation: pulse 1s infinite; }
    #sync-bar .sync-dot.error { background: #ef4444; }

    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

    /* ---- TREE LAYOUT ---- */
    .tree {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .tree .children {
      display: flex;
      justify-content: center;
      position: relative;
    }

    .tree .child-branch {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      padding: 14px 4px 0;
    }

    .tree .child-branch::before {
      content: '';
      position: absolute;
      top: 0;
      left: calc(50% - 1px);
      width: 2px;
      height: 14px;
      background: #cbd5e1;
    }

    .tree .child-branch::after {
      content: '';
      position: absolute;
      top: 0;
      height: 2px;
      background: #cbd5e1;
    }

    .tree .children > .child-branch:first-child::after {
      left: 50%;
      right: 0;
    }

    .tree .children > .child-branch:last-child::after {
      left: 0;
      right: 50%;
    }

    .tree .children > .child-branch:only-child::after {
      display: none;
    }

    .tree .children > .child-branch:not(:first-child):not(:last-child)::after {
      left: 0;
      right: 0;
    }

    .connector-down {
      width: 2px;
      height: 14px;
      background: #cbd5e1;
      margin: 0 auto;
    }

    .role-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    /* ---- NODE CARDS ---- */
    .node {
      background: #fff;
      border-radius: 10px;
      padding: 10px 12px;
      width: 148px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
      border-left: 3px solid #cbd5e1;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;
      position: relative;
    }

    .node:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12), 0 0 0 2px rgba(16,185,129,0.2);
    }

    .node.highlight {
      box-shadow: 0 0 0 3px #10b981, 0 8px 24px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }

    .node.dimmed { opacity: 0.25; }

    .node .name {
      font-weight: 700;
      font-size: 11.5px;
      margin-bottom: 2px;
      color: #0f172a;
    }

    .node .role {
      font-size: 9.5px;
      color: #64748b;
      margin-bottom: 4px;
    }

    .node .dept {
      font-size: 8px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 2px 7px;
      border-radius: 8px;
      display: inline-block;
    }

    .node .count-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #0f172a;
      color: #fff;
      font-size: 9px;
      font-weight: 700;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    /* ---- DEPARTMENT COLORS ---- */
    .dept-exec { border-left-color: #6366f1; }
    .dept-exec .dept { background: #eef2ff; color: #4338ca; }

    .dept-dev { border-left-color: #10b981; }
    .dept-dev .dept { background: #ecfdf5; color: #047857; }

    .dept-3d { border-left-color: #f59e0b; }
    .dept-3d .dept { background: #fffbeb; color: #b45309; }

    .dept-qa { border-left-color: #ef4444; }
    .dept-qa .dept { background: #fef2f2; color: #b91c1c; }

    .dept-mgmt { border-left-color: #8b5cf6; }
    .dept-mgmt .dept { background: #f5f3ff; color: #6d28d9; }

    .dept-design { border-left-color: #ec4899; }
    .dept-design .dept { background: #fdf2f8; color: #be185d; }

    .dept-hr { border-left-color: #14b8a6; }
    .dept-hr .dept { background: #f0fdfa; color: #0f766e; }

    .dept-it { border-left-color: #64748b; }
    .dept-it .dept { background: #f1f5f9; color: #334155; }

    /* ---- LOADING / ERROR ---- */
    #loading {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #0f172a;
      z-index: 1000;
      flex-direction: column;
      gap: 16px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #1e293b;
      border-top-color: #10b981;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    #error {
      display: none;
      position: fixed;
      inset: 0;
      background: #0f172a;
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      gap: 12px;
    }

    #error h2 { color: #ef4444; }
    #error p { color: #94a3b8; max-width: 500px; text-align: center; }

    /* ---- TOAST ---- */
    #toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #0f172a;
      color: #f1f5f9;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
      z-index: 600;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s, transform 0.3s;
      pointer-events: none;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }

    #toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* ---- DETAIL POPUP ---- */
    #detail-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.5);
      backdrop-filter: blur(4px);
      z-index: 400;
      align-items: center;
      justify-content: center;
    }

    #detail-overlay.open { display: flex; }

    #detail-card {
      background: #fff;
      border-radius: 14px;
      padding: 0;
      width: 380px;
      box-shadow: 0 24px 64px rgba(0,0,0,0.2);
      overflow: hidden;
    }

    .detail-header {
      padding: 24px 28px 16px;
      border-bottom: 1px solid #f1f5f9;
      position: relative;
    }

    .detail-dept-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
    }

    .detail-name {
      font-size: 18px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 2px;
    }

    .detail-role {
      font-size: 13px;
      color: #64748b;
    }

    .detail-body {
      padding: 16px 28px 24px;
    }

    .detail-row {
      display: flex;
      align-items: baseline;
      padding: 8px 0;
      border-bottom: 1px solid #f1f5f9;
    }

    .detail-row:last-child { border-bottom: none; }

    .detail-label {
      font-size: 11px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      width: 100px;
      flex-shrink: 0;
    }

    .detail-value {
      font-size: 13px;
      color: #0f172a;
    }

    .detail-actions {
      padding: 0 28px 20px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .detail-actions button {
      padding: 7px 16px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      font-family: inherit;
      color: #334155;
      transition: all 0.15s;
    }

    .detail-actions button:hover { background: #f8fafc; border-color: #cbd5e1; }

    /* ---- PASSWORD MODAL ---- */
    #password-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.5);
      backdrop-filter: blur(4px);
      z-index: 500;
      align-items: center;
      justify-content: center;
    }

    #password-overlay.open { display: flex; }

    #password-card {
      background: #fff;
      border-radius: 14px;
      padding: 28px;
      width: 340px;
      box-shadow: 0 24px 64px rgba(0,0,0,0.2);
    }

    #password-card h3 {
      font-size: 16px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 16px;
    }

    #password-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    #password-input:focus { border-color: #10b981; box-shadow: 0 0 0 2px rgba(16,185,129,0.2); }

    #password-error {
      color: #dc2626;
      font-size: 12px;
      margin-top: 6px;
      min-height: 18px;
    }

    #password-buttons {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 16px;
    }

    #password-buttons button {
      padding: 8px 18px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
      color: #334155;
      transition: all 0.15s;
    }

    #password-buttons button:hover { background: #f8fafc; border-color: #cbd5e1; }

    /* ---- MOBILE ---- */
    @media (max-width: 768px) {
      /* Toolbar: two-row layout */
      #toolbar {
        padding: 10px 12px 8px;
        gap: 0;
        flex-wrap: wrap;
        align-items: center;
      }

      #toolbar-logo { height: 24px; }

      #toolbar h1 {
        font-size: 15px;
        margin-right: auto;
        margin-left: 8px;
      }

      #toolbar button {
        padding: 5px 10px;
        font-size: 12px;
        margin-left: 6px;
      }

      #search-box {
        order: 10;
        width: 100%;
        margin-top: 8px;
        font-size: 14px;
        padding: 8px 12px;
      }

      /* Stats bar: compact single row */
      #stats {
        padding: 8px 12px;
        gap: 6px;
        overflow-x: auto;
        flex-wrap: nowrap;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
      }

      #stats::-webkit-scrollbar { display: none; }

      .stat-value { font-size: 15px; }
      .stat-label { font-size: 9px; letter-spacing: 0.3px; }
      .stat-divider { height: 18px; flex-shrink: 0; }
      .stat-item { flex-shrink: 0; }

      .dept-stats {
        display: none;
      }

      /* Viewport: edge-to-edge */
      #viewport {
        margin: 0;
        border-radius: 0;
        border-left: none;
        border-right: none;
      }

      /* Legend */
      #legend {
        bottom: 6px;
        left: 6px;
        padding: 6px 10px;
        gap: 6px;
        max-width: calc(100% - 12px);
        border-radius: 6px;
      }

      .legend-item { font-size: 9px; }

      /* Admin table on mobile */
      #admin-header { padding: 14px 16px; }
      #admin-header h2 { font-size: 16px; }
      #admin-actions { padding: 10px 16px; }
      #admin-search { width: auto; flex: 1; font-size: 14px; padding: 8px 12px; }
      #admin-table th, #admin-table td { padding: 8px 10px; font-size: 12px; }

      /* Edit form modal */
      #edit-form {
        width: calc(100vw - 32px);
        max-width: 420px;
        padding: 20px;
        max-height: 85vh;
      }

      /* Detail popup */
      #detail-card {
        width: calc(100vw - 32px);
        max-width: 380px;
      }

      /* Node cards */
      .node {
        width: 120px;
        padding: 6px 8px;
      }

      .node .name { font-size: 10px; }
      .node .role { font-size: 9px; }
      .node .dept { font-size: 7.5px; }

      .node .count-badge {
        width: 16px;
        height: 16px;
        font-size: 8px;
        top: -5px;
        right: -5px;
      }

      /* Toast */
      #toast {
        left: 16px;
        right: 16px;
        bottom: 16px;
        text-align: center;
      }
    }

    @media (max-width: 420px) {
      #toolbar h1 { font-size: 13px; }
      #toolbar-logo { height: 20px; }

      .stat-item:nth-child(n+8) { display: none; }

      .node {
        width: 100px;
        padding: 5px 6px;
      }

      .node .name { font-size: 9px; }
      .node .role { font-size: 8px; }
      .node .dept { font-size: 7px; padding: 1px 4px; }

      .child-branch { padding: 10px 2px 0; }
      .connector-down { height: 10px; }
    }
  </style>
</head>
<body>

  <div id="loading">
    <div class="spinner"></div>
    <div style="color:#94a3b8; font-size:14px; font-weight:500;">Loading org chart...</div>
  </div>

  <div id="error">
    <h2>Failed to load data</h2>
    <p id="error-msg"></p>
  </div>

  <div id="toolbar">
    <img id="toolbar-logo" src="logo.png" alt="3DSource" />
    <h1>Org Chart 2026</h1>
    <input type="text" id="search-box" placeholder="Search employees..." />
    <button onclick="resetView()">Reset View</button>
    <button id="btn-admin" onclick="toggleAdmin()">Admin</button>
  </div>

  <div id="stats"></div>

  <div id="main">
    <div id="viewport">
      <div id="canvas">
        <div id="chart-container"></div>
      </div>
      <div id="legend"></div>
    </div>

    <div id="admin-panel">
      <div id="admin-header">
        <h2>Manage Employees</h2>
        <button class="btn-primary" onclick="openAddForm()">+ Add</button>
        <button id="admin-close-btn" onclick="toggleAdmin()">Close</button>
      </div>
      <div id="admin-actions">
        <input type="text" id="admin-search" placeholder="Filter employees..." oninput="renderAdminList()" />
      </div>
      <div id="admin-list"></div>
      <div id="sync-bar">
        <div class="sync-dot" id="sync-dot"></div>
        <span id="sync-status">Synced with Google Sheets</span>
      </div>
    </div>
  </div>

  <!-- Edit/Add Modal -->
  <div id="edit-overlay" onclick="if(event.target===this)closeEditForm()">
    <div id="edit-form">
      <h3 id="form-title">Edit Employee</h3>
      <input type="hidden" id="form-original-id" />
      <div class="form-group">
        <label>Full Name</label>
        <input type="text" id="form-name" placeholder="e.g. Jane Smith" />
      </div>
      <div class="form-group">
        <label>Role / Title</label>
        <input type="text" id="form-role" placeholder="e.g. Front End Dev" />
      </div>
      <div class="form-group">
        <label>Department</label>
        <select id="form-dept">
          <option value="Exec">Exec</option>
          <option value="Dev">Dev</option>
          <option value="3D">3D</option>
          <option value="QA">QA</option>
          <option value="MGMT">MGMT</option>
          <option value="Design">Design</option>
          <option value="HR">HR</option>
          <option value="IT">IT</option>
        </select>
      </div>
      <div class="form-group">
        <label>Reports To</label>
        <select id="form-manager"></select>
      </div>
      <div class="form-group">
        <label>Location</label>
        <input type="text" id="form-location" placeholder="e.g. New York, NY" />
      </div>
      <div class="form-group">
        <label>Start Date</label>
        <input type="text" id="form-start" placeholder="e.g. Jan 13, 2023" />
        <span style="font-size:11px; color:#94a3b8; margin-top:2px;">Format: Mon DD, YYYY</span>
      </div>
      <div class="form-buttons">
        <button id="form-delete-btn" class="btn-danger" onclick="deleteEmployee()" style="margin-right:auto">Delete</button>
        <button onclick="closeEditForm()">Cancel</button>
        <button class="btn-primary" onclick="saveEmployee()">Save</button>
      </div>
    </div>
  </div>

  <!-- Detail Popup -->
  <div id="detail-overlay" onclick="if(event.target===this)closeDetail()">
    <div id="detail-card">
      <div class="detail-header">
        <div class="detail-dept-bar" id="detail-dept-bar"></div>
        <div class="detail-name" id="detail-name"></div>
        <div class="detail-role" id="detail-role"></div>
      </div>
      <div class="detail-body" id="detail-body"></div>
      <div class="detail-actions">
        <button onclick="editFromDetail()" id="detail-edit-btn" style="display:none" class="btn-primary">Edit</button>
        <button onclick="closeDetail()">Close</button>
      </div>
    </div>
  </div>

  <!-- Password Modal -->
  <div id="password-overlay" onclick="if(event.target===this)closePasswordModal()">
    <div id="password-card">
      <h3>Enter admin password</h3>
      <input type="password" id="password-input" placeholder="Password" autocomplete="off" />
      <div id="password-error"></div>
      <div id="password-buttons">
        <button onclick="closePasswordModal()">Cancel</button>
        <button class="btn-primary" onclick="submitPassword()">OK</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    // ---- CONFIG ----
    // Paste your deployed Apps Script Web App URL here (see AppsScript.gs for setup instructions)
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwiv7YnsXWPKA8PGYiVObZPTeDSxhLdeiPFtRO8BTqUxSlYYiNfqb5IGwpICf4wfvgF/exec';

    const DEPT_COLORS = {
      'Exec':   { border: '#6366f1', bg: '#eef2ff', text: '#4338ca', dot: '#6366f1' },
      'Dev':    { border: '#10b981', bg: '#ecfdf5', text: '#047857', dot: '#10b981' },
      '3D':     { border: '#f59e0b', bg: '#fffbeb', text: '#b45309', dot: '#f59e0b' },
      'QA':     { border: '#ef4444', bg: '#fef2f2', text: '#b91c1c', dot: '#ef4444' },
      'MGMT':   { border: '#8b5cf6', bg: '#f5f3ff', text: '#6d28d9', dot: '#8b5cf6' },
      'Design': { border: '#ec4899', bg: '#fdf2f8', text: '#be185d', dot: '#ec4899' },
      'HR':     { border: '#14b8a6', bg: '#f0fdfa', text: '#0f766e', dot: '#14b8a6' },
      'IT':     { border: '#64748b', bg: '#f1f5f9', text: '#334155', dot: '#64748b' },
    };

    // ---- STATE ----
    let scale = 1;
    let translateX = 0;
    let translateY = 0;
    let isDragging = false;
    let dragStartX, dragStartY;
    let employees = {};
    let childrenMap = {};
    let rootEmp = null;
    let hasUnsavedChanges = false;
    let adminUnlocked = sessionStorage.getItem('admin_unlocked') === '1';
    // Obfuscated password check
    const _ak = [100,114,101,97,109,115,111,102,116];

    let _passwordCallback = null;

    function checkAdminPassword(onSuccess) {
      if (adminUnlocked) { onSuccess(); return; }
      _passwordCallback = onSuccess;
      document.getElementById('password-input').value = '';
      document.getElementById('password-error').textContent = '';
      document.getElementById('password-overlay').classList.add('open');
      setTimeout(() => document.getElementById('password-input').focus(), 50);
    }

    function submitPassword() {
      const input = document.getElementById('password-input').value;
      if (!input) { document.getElementById('password-error').textContent = 'Please enter a password'; return; }
      const match = input.split('').every((c, i) => c.charCodeAt(0) === _ak[i]) && input.length === _ak.length;
      if (match) {
        adminUnlocked = true;
        sessionStorage.setItem('admin_unlocked', '1');
        const cb = _passwordCallback;
        closePasswordModal();
        showToast('Admin access granted');
        if (cb) cb();
      } else {
        document.getElementById('password-error').textContent = 'Incorrect password';
        document.getElementById('password-input').value = '';
        document.getElementById('password-input').focus();
      }
    }

    function closePasswordModal() {
      document.getElementById('password-overlay').classList.remove('open');
      _passwordCallback = null;
    }

    // ---- TOAST ----
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2500);
    }

    // ---- FORMAT HELPERS ----
    function formatStartDate(raw) {
      if (!raw) return '';
      const d = new Date(raw);
      if (isNaN(d)) return raw;
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function formatYears(raw) {
      if (!raw && raw !== 0) return '';
      const n = parseFloat(raw);
      if (isNaN(n)) return raw;
      return n.toFixed(1);
    }

    // ---- DETAIL POPUP ----
    let detailEmpId = null;

    function openDetail(empId) {
      const emp = employees[empId];
      if (!emp) return;
      detailEmpId = empId;

      const color = DEPT_COLORS[emp.department] || { border: '#94a3b8' };
      document.getElementById('detail-dept-bar').style.background = color.border;
      document.getElementById('detail-name').textContent = emp.name;
      document.getElementById('detail-role').textContent = emp.role;

      const manager = emp.managerId && employees[emp.managerId]
        ? employees[emp.managerId].name
        : 'None';
      const reports = (childrenMap[emp.id] || []).length;

      let rows = '';
      rows += `<div class="detail-row"><div class="detail-label">Department</div><div class="detail-value">${emp.department}</div></div>`;
      rows += `<div class="detail-row"><div class="detail-label">Reports To</div><div class="detail-value">${manager}</div></div>`;
      rows += `<div class="detail-row"><div class="detail-label">Direct Reports</div><div class="detail-value">${reports}</div></div>`;
      if (emp.location) rows += `<div class="detail-row"><div class="detail-label">Location</div><div class="detail-value">${emp.location}</div></div>`;
      if (emp.start) rows += `<div class="detail-row"><div class="detail-label">Start Date</div><div class="detail-value">${formatStartDate(emp.start)}</div></div>`;
      if (emp.years) rows += `<div class="detail-row"><div class="detail-label">Years</div><div class="detail-value">${formatYears(emp.years)}</div></div>`;

      document.getElementById('detail-body').innerHTML = rows;
      document.getElementById('detail-edit-btn').style.display = adminUnlocked ? '' : 'none';
      document.getElementById('detail-overlay').classList.add('open');
    }

    function closeDetail() {
      document.getElementById('detail-overlay').classList.remove('open');
      detailEmpId = null;
    }

    function editFromDetail() {
      const id = detailEmpId;
      closeDetail();
      openEditForm(id);
    }

    // ---- FETCH DATA ----
    async function fetchData() {
      const res = await fetch(APPS_SCRIPT_URL);
      if (!res.ok) throw new Error(`Apps Script returned ${res.status}`);
      const data = await res.json();
      if (!data.success) throw new Error(data.error || 'Failed to load data');
      return data.employees;
    }

    function indexEmployees(empList) {
      const emps = {};
      for (const emp of empList) {
        emps[emp.id] = emp;
      }
      return emps;
    }

    function buildTree(emps) {
      const cMap = {};
      const roots = [];

      for (const id in emps) {
        const emp = emps[id];
        const managerId = emp.managerId;
        if (!managerId || managerId === '\u2014' || managerId === '-' || !emps[managerId]) {
          roots.push(emp);
        } else {
          if (!cMap[managerId]) cMap[managerId] = [];
          cMap[managerId].push(emp);
        }
      }

      // Pick the root with the most reports; attach others as its direct reports
      let root = roots[0] || null;
      if (roots.length > 1) {
        roots.sort((a, b) => countReports(b.id, cMap) - countReports(a.id, cMap));
        root = roots[0];
        for (let i = 1; i < roots.length; i++) {
          if (!cMap[root.id]) cMap[root.id] = [];
          cMap[root.id].push(roots[i]);
        }
      }

      for (const id in cMap) {
        cMap[id].sort((a, b) => {
          const aHasKids = cMap[a.id] ? 1 : 0;
          const bHasKids = cMap[b.id] ? 1 : 0;
          if (bHasKids !== aHasKids) return bHasKids - aHasKids;
          return a.name.localeCompare(b.name);
        });
      }

      return { root, childrenMap: cMap };
    }



    function countReports(id, cMap) {
      const direct = cMap[id] || [];
      let total = direct.length;
      for (const child of direct) {
        total += countReports(child.id, cMap);
      }
      return total;
    }

    function generateId(name) {
      return name.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
    }

    // ---- REBUILD & RE-RENDER ----
    function rebuild() {
      const result = buildTree(employees);
      rootEmp = result.root;
      childrenMap = result.childrenMap;

      renderStats(employees, childrenMap);
      const container = document.getElementById('chart-container');
      container.innerHTML = renderNode(rootEmp, childrenMap);
      renderLegend();
      renderAdminList();

      requestAnimationFrame(() => {
        requestAnimationFrame(() => centerChart());
      });
    }

    // ---- STATS ----
    function renderStats(emps, cMap) {
      const total = Object.keys(emps).length;
      const deptCounts = {};
      for (const id in emps) {
        const d = emps[id].department;
        deptCounts[d] = (deptCounts[d] || 0) + 1;
      }
      const numDepts = Object.keys(deptCounts).length;
      let numManagers = 0;
      for (const id in cMap) {
        if (cMap[id].length > 0) numManagers++;
      }
      const roles = new Set();
      let tenureSum = 0;
      let tenureCount = 0;
      for (const id in emps) {
        roles.add(emps[id].role);
        const y = parseFloat(emps[id].years);
        if (!isNaN(y)) { tenureSum += y; tenureCount++; }
      }
      const avgTenure = tenureCount > 0 ? (tenureSum / tenureCount).toFixed(1) : 'â€”';

      let html = '';
      html += `<div class="stat-item"><span class="stat-value">${total}</span><span class="stat-label">Headcount</span></div>`;
      html += `<div class="stat-divider"></div>`;
      html += `<div class="stat-item"><span class="stat-value">${numDepts}</span><span class="stat-label">Departments</span></div>`;
      html += `<div class="stat-divider"></div>`;
      html += `<div class="stat-item"><span class="stat-value">${numManagers}</span><span class="stat-label">Managers</span></div>`;
      html += `<div class="stat-divider"></div>`;
      html += `<div class="stat-item"><span class="stat-value">${roles.size}</span><span class="stat-label">Roles</span></div>`;
      html += `<div class="stat-divider"></div>`;
      html += `<div class="stat-item"><span class="stat-value">${avgTenure}<span style="font-size:12px;font-weight:400;color:#64748b"> yr</span></span><span class="stat-label">Avg Tenure</span></div>`;

      html += `<div class="dept-stats">`;
      const sortedDepts = Object.entries(deptCounts).sort((a, b) => b[1] - a[1]);
      for (const [dept, count] of sortedDepts) {
        const color = DEPT_COLORS[dept] ? DEPT_COLORS[dept].dot : '#94a3b8';
        html += `<div class="dept-stat">
          <div class="dept-stat-dot" style="background:${color}"></div>
          ${dept} <span class="dept-stat-count">${count}</span>
        </div>`;
      }
      html += `</div>`;
      document.getElementById('stats').innerHTML = html;
    }

    // ---- RENDER CHART ----
    function deptClass(dept) {
      return 'dept-' + dept.toLowerCase().replace(/\s+/g, '');
    }

    function renderCardHTML(emp, cMap) {
      const totalReports = countReports(emp.id, cMap);
      const badgeHTML = totalReports > 0
        ? `<div class="count-badge" title="${totalReports} total reports">${totalReports}</div>`
        : '';
      return `<div class="node ${deptClass(emp.department)}" data-id="${emp.id}" data-name="${emp.name.toLowerCase()}">
        ${badgeHTML}
        <div class="name">${emp.name}</div>
        <div class="role">${emp.role}</div>
        <div class="dept">${emp.department}</div>
      </div>`;
    }

    function renderNode(emp, cMap) {
      const kids = cMap[emp.id] || [];
      let html = `<div class="tree">`;
      html += renderCardHTML(emp, cMap);

      if (kids.length > 0) {
        const managers = kids.filter(k => cMap[k.id] && cMap[k.id].length > 0);
        const leaves = kids.filter(k => !cMap[k.id] || cMap[k.id].length === 0);
        const roleGroups = {};
        for (const leaf of leaves) {
          const role = leaf.role;
          if (!roleGroups[role]) roleGroups[role] = [];
          roleGroups[role].push(leaf);
        }
        const groupedLeaves = Object.values(roleGroups);

        html += `<div class="connector-down"></div>`;
        html += `<div class="children">`;
        for (const child of managers) {
          html += `<div class="child-branch">`;
          html += renderNode(child, cMap);
          html += `</div>`;
        }
        for (const group of groupedLeaves) {
          html += `<div class="child-branch">`;
          html += `<div class="role-group">`;
          for (const leaf of group) {
            html += renderCardHTML(leaf, cMap);
          }
          html += `</div>`;
          html += `</div>`;
        }
        html += `</div>`;
      }

      html += `</div>`;
      return html;
    }

    function renderLegend() {
      const legend = document.getElementById('legend');
      let html = '';
      for (const dept in DEPT_COLORS) {
        const c = DEPT_COLORS[dept];
        html += `<div class="legend-item">
          <div class="legend-dot" style="background:${c.dot}"></div>
          ${dept}
        </div>`;
      }
      legend.innerHTML = html;
    }

    // ---- ADMIN PANEL ----
    function toggleAdmin() {
      const panel = document.getElementById('admin-panel');
      if (!panel.classList.contains('open')) {
        checkAdminPassword(() => {
          panel.classList.add('open');
          renderAdminList();
        });
        return;
      }
      panel.classList.remove('open');
    }

    function renderAdminList() {
      const list = document.getElementById('admin-list');
      const filter = (document.getElementById('admin-search').value || '').toLowerCase();
      const sorted = Object.values(employees).sort((a, b) => a.name.localeCompare(b.name));

      document.querySelector('#admin-header h2').textContent = 'Manage Employees (' + sorted.length + ')';

      let html = '<table id="admin-table"><thead><tr>';
      html += '<th>Name</th>';
      html += '<th>Role</th>';
      html += '<th>Department</th>';
      html += '<th>Reports To</th>';
      html += '<th>Location</th>';
      html += '<th>Start Date</th>';
      html += '<th></th>';
      html += '</tr></thead><tbody>';

      for (const emp of sorted) {
        if (filter && !emp.name.toLowerCase().includes(filter) && !emp.role.toLowerCase().includes(filter) && !emp.department.toLowerCase().includes(filter)) continue;
        const color = DEPT_COLORS[emp.department] || { bg: '#f1f5f9', text: '#64748b' };
        const managerName = emp.managerId && employees[emp.managerId] ? employees[emp.managerId].name : '\u2014';
        html += `<tr onclick="openEditForm('${emp.id}')">`;
        html += `<td style="font-weight:600">${emp.name}</td>`;
        html += `<td>${emp.role}</td>`;
        html += `<td><span class="admin-dept-badge" style="background:${color.bg};color:${color.text}">${emp.department}</span></td>`;
        html += `<td>${managerName}</td>`;
        html += `<td>${emp.location || '\u2014'}</td>`;
        html += `<td>${formatStartDate(emp.start) || '\u2014'}</td>`;
        html += `<td><button class="admin-edit-btn" onclick="event.stopPropagation();openEditForm('${emp.id}')">Edit</button></td>`;
        html += `</tr>`;
      }

      html += '</tbody></table>';
      list.innerHTML = html;
    }

    // ---- EDIT FORM ----
    function populateManagerDropdown(excludeId) {
      const select = document.getElementById('form-manager');
      const sorted = Object.values(employees).sort((a, b) => a.name.localeCompare(b.name));
      let html = `<option value="">(None - top of org)</option>`;
      for (const emp of sorted) {
        if (emp.id === excludeId) continue;
        html += `<option value="${emp.id}">${emp.name} (${emp.role})</option>`;
      }
      select.innerHTML = html;
    }

    function openEditForm(empId) {
      const emp = employees[empId];
      if (!emp) return;

      document.getElementById('form-title').textContent = 'Edit Employee';
      document.getElementById('form-original-id').value = empId;
      document.getElementById('form-name').value = emp.name;
      document.getElementById('form-role').value = emp.role;
      document.getElementById('form-dept').value = emp.department;
      document.getElementById('form-delete-btn').style.display = '';
      document.getElementById('form-location').value = emp.location || '';
      document.getElementById('form-start').value = formatStartDate(emp.start);

      populateManagerDropdown(empId);
      document.getElementById('form-manager').value = emp.managerId || '';

      document.getElementById('edit-overlay').classList.add('open');
    }

    function openAddForm() {
      document.getElementById('form-title').textContent = 'Add Employee';
      document.getElementById('form-original-id').value = '';
      document.getElementById('form-name').value = '';
      document.getElementById('form-role').value = '';
      document.getElementById('form-dept').value = 'Dev';
      document.getElementById('form-delete-btn').style.display = 'none';
      document.getElementById('form-location').value = '';
      document.getElementById('form-start').value = '';

      populateManagerDropdown(null);
      document.getElementById('form-manager').value = '';

      document.getElementById('edit-overlay').classList.add('open');
    }

    function closeEditForm() {
      document.getElementById('edit-overlay').classList.remove('open');
    }

    function saveEmployee() {
      const originalId = document.getElementById('form-original-id').value;
      const name = document.getElementById('form-name').value.trim();
      const role = document.getElementById('form-role').value.trim();
      const dept = document.getElementById('form-dept').value;
      const managerId = document.getElementById('form-manager').value;
      const location = document.getElementById('form-location').value.trim();
      const start = document.getElementById('form-start').value.trim();

      if (!name) { showToast('Name is required'); return; }
      if (!role) { showToast('Role is required'); return; }

      const newId = generateId(name);
      const existingYears = originalId && employees[originalId] ? employees[originalId].years : '';

      if (originalId) {
        // Editing existing employee
        delete employees[originalId];
        // Update any employees that reported to the old ID
        if (originalId !== newId) {
          for (const id in employees) {
            if (employees[id].managerId === originalId) {
              employees[id].managerId = newId;
            }
          }
        }
      } else {
        // Adding new employee - check for duplicate
        if (employees[newId]) {
          showToast('An employee with a similar name already exists');
          return;
        }
      }

      employees[newId] = { id: newId, name, role, department: dept, managerId, location, start, years: existingYears };

      closeEditForm();
      rebuild();
      showToast(originalId ? `Updated ${name}` : `Added ${name}`);
      saveToSheet();
    }

    function deleteEmployee() {
      const originalId = document.getElementById('form-original-id').value;
      if (!originalId) return;
      const emp = employees[originalId];
      if (!emp) return;

      const reports = childrenMap[originalId] || [];
      if (reports.length > 0) {
        // Reassign reports to the deleted employee's manager
        for (const report of reports) {
          employees[report.id].managerId = emp.managerId;
        }
      }

      delete employees[originalId];

      closeEditForm();
      rebuild();
      showToast(`Removed ${emp.name}`);
      saveToSheet();
    }

    // ---- SYNC STATUS ----
    function markUnsaved() {
      hasUnsavedChanges = true;
      document.getElementById('sync-dot').className = 'sync-dot unsaved';
      document.getElementById('sync-status').textContent = 'Unsaved changes';
    }

    function markSaved() {
      hasUnsavedChanges = false;
      document.getElementById('sync-dot').className = 'sync-dot';
      document.getElementById('sync-status').textContent = 'Synced with Google Sheets';
    }

    function markSaving() {
      hasUnsavedChanges = true;
      document.getElementById('sync-dot').className = 'sync-dot saving';
      document.getElementById('sync-status').textContent = 'Saving...';
    }

    function markError(msg) {
      hasUnsavedChanges = true;
      document.getElementById('sync-dot').className = 'sync-dot error';
      document.getElementById('sync-status').textContent = msg;
    }

    // ---- SAVE TO GOOGLE SHEETS (via Apps Script) ----
    async function saveToSheet() {
      markSaving();

      const sorted = Object.values(employees).sort((a, b) => a.name.localeCompare(b.name));

      try {
        const res = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({
            action: 'save_all',
            employees: sorted,
          }),
        });

        // Apps Script redirects, so we follow it
        const data = await res.json();

        if (!data.success) {
          throw new Error(data.error || 'Save failed');
        }

        markSaved();
        showToast(`Saved ${sorted.length} employees to Google Sheets`);
      } catch (err) {
        console.error('Save failed:', err);
        markError('Save failed');
        showToast('Save failed: ' + err.message);
      }
    }

    // ---- PAN & ZOOM ----
    const MIN_SCALE = 0.3;
    const MAX_SCALE = 2;

    function applyTransform() {
      const container = document.getElementById('chart-container');
      container.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    }

    function resetView() {
      scale = 1;
      translateX = 0;
      translateY = 0;
      applyTransform();
      centerChart();
    }

    function centerChart() {
      const canvas = document.getElementById('canvas');
      const container = document.getElementById('chart-container');
      const cw = container.scrollWidth;
      const ch = container.scrollHeight;
      const vw = canvas.clientWidth;
      const vh = canvas.clientHeight;

      scale = Math.max(Math.min(vw / cw, vh / ch, 1) * 0.9, MIN_SCALE);
      translateX = (vw - cw * scale) / 2;
      translateY = (vh - ch * scale) / 2;
      applyTransform();
    }

    // ---- SEARCH ----
    function handleSearch(query) {
      const nodes = document.querySelectorAll('.node');
      if (!query) {
        nodes.forEach(n => { n.classList.remove('highlight', 'dimmed'); });
        return;
      }
      const q = query.toLowerCase();
      let hasMatch = false;
      nodes.forEach(n => {
        const name = n.getAttribute('data-name');
        const role = n.querySelector('.role').textContent.toLowerCase();
        const dept = n.querySelector('.dept').textContent.toLowerCase();
        if (name.includes(q) || role.includes(q) || dept.includes(q)) {
          n.classList.add('highlight');
          n.classList.remove('dimmed');
          hasMatch = true;
        } else {
          n.classList.remove('highlight');
          n.classList.add('dimmed');
        }
      });
      if (!hasMatch) {
        nodes.forEach(n => { n.classList.remove('highlight', 'dimmed'); });
      }
    }

    // ---- INIT ----
    async function init() {
      try {
        const empList = await fetchData();
        employees = indexEmployees(empList);
        const result = buildTree(employees);
        rootEmp = result.root;
        childrenMap = result.childrenMap;

        if (!rootEmp) throw new Error('Could not find the root of the org tree (CEO with no manager).');

        renderStats(employees, childrenMap);

        const container = document.getElementById('chart-container');
        container.innerHTML = renderNode(rootEmp, childrenMap);

        renderLegend();
        renderAdminList();

        document.getElementById('loading').style.display = 'none';

        requestAnimationFrame(() => {
          requestAnimationFrame(() => centerChart());
        });

      } catch (err) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'flex';
        document.getElementById('error-msg').textContent = err.message;
        console.error(err);
      }
    }

    // ---- EVENT LISTENERS ----
    const canvas = document.getElementById('canvas');

    // Click on card to open detail (but not during drag)
    let mouseDownPos = null;
    canvas.addEventListener('mousedown', (e) => {
      mouseDownPos = { x: e.clientX, y: e.clientY };
      isDragging = true;
      dragStartX = e.clientX - translateX;
      dragStartY = e.clientY - translateY;
      canvas.classList.add('grabbing');
    });

    window.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      translateX = e.clientX - dragStartX;
      translateY = e.clientY - dragStartY;
      applyTransform();
    });

    window.addEventListener('mouseup', (e) => {
      isDragging = false;
      canvas.classList.remove('grabbing');

      // If mouse barely moved, treat as click on card
      if (mouseDownPos && Math.abs(e.clientX - mouseDownPos.x) < 4 && Math.abs(e.clientY - mouseDownPos.y) < 4) {
        const node = e.target.closest('.node');
        if (node) {
          const empId = node.getAttribute('data-id');
          if (empId) openDetail(empId);
        }
      }
      mouseDownPos = null;
    });

    canvas.addEventListener('wheel', (e) => {
      e.preventDefault();
      const delta = e.deltaY > 0 ? 0.9 : 1.1;
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      const newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, scale * delta));
      const ratio = newScale / scale;

      translateX = mouseX - ratio * (mouseX - translateX);
      translateY = mouseY - ratio * (mouseY - translateY);
      scale = newScale;
      applyTransform();
    }, { passive: false });

    // ---- TOUCH EVENTS ----
    let touchStartPos = null;
    let lastTouchDist = 0;
    let touchMoved = false;

    canvas.addEventListener('touchstart', (e) => {
      if (e.touches.length === 1) {
        const t = e.touches[0];
        touchStartPos = { x: t.clientX, y: t.clientY };
        dragStartX = t.clientX - translateX;
        dragStartY = t.clientY - translateY;
        touchMoved = false;
      } else if (e.touches.length === 2) {
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        lastTouchDist = Math.sqrt(dx * dx + dy * dy);
        touchMoved = true;
      }
    }, { passive: true });

    canvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      if (e.touches.length === 1 && touchStartPos) {
        const t = e.touches[0];
        if (Math.abs(t.clientX - touchStartPos.x) > 4 || Math.abs(t.clientY - touchStartPos.y) > 4) {
          touchMoved = true;
        }
        translateX = t.clientX - dragStartX;
        translateY = t.clientY - dragStartY;
        applyTransform();
      } else if (e.touches.length === 2) {
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        const dist = Math.sqrt(dx * dx + dy * dy);

        if (lastTouchDist > 0) {
          const midX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
          const midY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
          const rect = canvas.getBoundingClientRect();
          const cx = midX - rect.left;
          const cy = midY - rect.top;

          const newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, scale * (dist / lastTouchDist)));
          const ratio = newScale / scale;
          translateX = cx - ratio * (cx - translateX);
          translateY = cy - ratio * (cy - translateY);
          scale = newScale;
          applyTransform();
        }
        lastTouchDist = dist;
      }
    }, { passive: false });

    canvas.addEventListener('touchend', (e) => {
      if (e.touches.length === 0) {
        // Tap to open detail
        if (!touchMoved && touchStartPos) {
          const node = e.target.closest('.node');
          if (node) {
            const empId = node.getAttribute('data-id');
            if (empId) openDetail(empId);
          }
        }
        touchStartPos = null;
        lastTouchDist = 0;
      }
    }, { passive: true });

    document.getElementById('search-box').addEventListener('input', (e) => {
      handleSearch(e.target.value.trim());
    });

    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'f') {
        e.preventDefault();
        document.getElementById('search-box').focus();
      }
      if (e.key === 'Escape') {
        closeDetail();
        closeEditForm();
        closePasswordModal();
      }
    });

    document.getElementById('password-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') submitPassword();
    });

    // Warn before leaving with unsaved changes
    window.addEventListener('beforeunload', (e) => {
      if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    init();
  </script>
</body>
</html>
